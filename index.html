<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poster Editor — movable round photos x2 (left) + colors + date + main movers</title>
<style>
  :root{
    --poster-width:800px; --poster-height:1200px;
    --slot-right:70px; --slot-top:160px; --slot-width:360px; --slot-height:720px;
    --left-margin:40px;
  }
  *{box-sizing:border-box}
  body{position:relative; display:flex;justify-content:center;padding:140px 20px 20px;background:#f3f4f6;font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial;margin:0}
  .poster-frame{width:var(--poster-width);height:var(--poster-height);position:relative;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);background:#fff}
  .poster-frame .bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;pointer-events:none}

  .headline{position:absolute;top:40px;left:var(--left-margin);z-index:60;color:#fff;text-shadow:0 3px 10px rgba(0,0,0,.45);max-width:calc(100% - var(--slot-width) - var(--slot-right) - 120px);background:rgba(255,255,255,0.06);padding:12px 16px;border-radius:12px;backdrop-filter:blur(6px);display:inline-block}
  .headline h1{margin:0;font-size:64px;line-height:0.95;white-space:nowrap; font-family:"Rogbold-3IIGM", system-ui, sans-serif;}
  .headline p{margin:8px 0 0 0;font-size:22px;color:rgba(255,255,255,.95);white-space:nowrap}

  /* main rectangular photo */
  .photo-slot{position:absolute;right:var(--slot-right);top:var(--slot-top);width:var(--slot-width);height:var(--slot-height);border-radius:18px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,.28);z-index:50;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);transition:height .18s ease}
  .photo-slot img{width:100%;height:100%;object-fit:cover;object-position:center;transform-origin:center;transition:transform .15s ease;display:block}
  .photo-slot::after{content:"";position:absolute;inset:auto 0 0 0;height:30%;background:linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,1) 100%);opacity:.85;pointer-events:none}

  /* round photo slot - two instances will share this style; initial left/top handled by JS */
  .round-slot{
    position:absolute;
    left:0; top:0;
    width:140px; height:140px;
    border-radius:50%;
    overflow:hidden;
    z-index:55;
    display:none;
    align-items:center;
    justify-content:center;
    background:transparent;
    cursor:grab;
    transition:all .12s;
    -webkit-user-select:none; user-select:none;
  }
  .round-slot.active{display:flex; box-shadow:0 14px 30px rgba(0,0,0,.28);}
  .round-slot img.round-img{
    display:block;
    width:160%;
    height:160%;
    object-fit:cover;
    object-position:center center;
    transform-origin:center center;
    transition:transform .12s ease;
    pointer-events:none;
  }
  .round-slot .frame-overlay{position:absolute; inset:0; pointer-events:none; width:100%; height:100%; object-fit:contain}

  .date-badge{
    position:absolute;
    left:0; top:0;
    z-index:53;
    display:none;
    background:transparent;
    padding:6px 10px;
    border-radius:8px;
    font-family:"Rogbold-3IIGM", system-ui, sans-serif;
    font-size:16px;
  }
  .date-badge[contenteditable]{outline:0}

  .info{position:absolute;left:40px;bottom:60px;width:calc(100% - 100px);max-width:700px;background:rgba(255,255,255,.45);color:#0b3a61;border-radius:10px;padding:16px 20px;box-shadow:0 8px 25px rgba(0,0,0,.10);z-index:60;backdrop-filter:blur(3px)}
  .info h2{margin:0 0 8px 0;font-size:20px}
  .info ul{margin:6px 0 0 18px;padding:0}
  .info li{margin:6px 0;line-height:1.35}

  .controls{position:absolute;bottom:15px;right:20px;z-index:90;display:flex;gap:8px;align-items:center;flex-wrap:wrap;max-width:680px}
  .controls input[type="file"]{display:none}
  .controls label,.controls button{background:#0a58ca;color:#fff;border:none;border-radius:8px;padding:8px 10px;cursor:pointer;font-weight:600}
  .zoom-btn{width:44px;height:44px;display:flex;align-items:center;justify-content:center;font-size:20px}

  /* extra round controls area (stacked smaller) */
  .round-controls { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .small { padding:6px 8px; font-size:14px; border-radius:6px; }

  #placeholder{color:#555;font-weight:600;text-align:center;padding:8px}

  /* Verse editor (floating) -- appears when Edit Verse clicked */
  .verse-editor {
    position: absolute;
    right: 20px;
    bottom: 85px;
    width: 320px;
    max-width: calc(100% - 60px);
    background: rgba(255,255,255,0.95);
    border-radius: 10px;
    padding: 10px;
    z-index: 110;
    box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    display: none;
  }
  .verse-editor h3 { margin: 0 0 8px 0; font-size:14px; color:#08314e; }
  .verse-editor [contenteditable] { min-height:36px; padding:6px; border-radius:6px; border:1px dashed rgba(10,20,40,0.06); background: rgba(250,250,250,0.98); }

  /* Background selector panel - top center of page */
  .bg-panel {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 130;
    background: rgba(255,255,255,0.98);
    border-radius: 8px;
    padding: 10px;
    box-shadow: 0 12px 35px rgba(0,0,0,0.18);
    display:flex;
    gap:12px;
    align-items:center;
  }
  .bg-grid { display:flex; gap:8px; flex-wrap:nowrap; overflow-x:auto; padding-bottom:4px; }
  .bg-thumb { width:64px; height:96px; object-fit:cover; border-radius:6px; cursor:pointer; border:2px solid transparent; flex:0 0 auto; }
  .bg-thumb.selected { border-color:#0a58ca; }

  .color-controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; padding:6px 0; }

  @media (max-width:900px){
    body{padding-top:100px}
    .bg-panel { left: 12px; transform: none; top: 12px; width: auto; padding:8px; overflow:hidden;}
    .bg-grid { gap:6px; }
    :root{--poster-width:360px;--poster-height:640px;--slot-width:150px;--slot-height:320px;--slot-top:90px;--slot-right:20px}
    .headline h1{font-size:36px}
    .info{width:calc(100% - 60px);left:30px;bottom:25px}
  }
</style>
</head>
<body>
  <div class="bg-panel" id="bgPanel">
    <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-start">
      <strong style="font-size:14px;color:#08314e">Backgrounds</strong>
      <button id="bgToggle" style="padding:6px 8px;border-radius:6px;background:#eee;border:none;cursor:pointer">Reset</button>
    </div>
    <div class="bg-grid" id="bgGrid" aria-hidden="false"></div>
  </div>

  <div class="poster-frame" id="poster">
    <img id="bgImage" class="bg" src="IMG-20251105-WA0012.jpg" alt="Poster background">
    <div class="photo-slot" id="slot">
      <img id="userImage" alt="Uploaded photo" style="display:none" />
      <div id="placeholder">Upload photo here</div>
    </div>

    <!-- round photo slots (left of main slot) -->
    <div class="round-slot" id="roundSlot1" title="Drag to reposition round image 1">
      <img id="roundImage1" class="round-img" alt="Round uploaded photo 1" style="display:none" />
      <img id="roundFrame1" class="frame-overlay" alt="Frame overlay 1" src="20251106_004524.png" style="display:none" />
    </div>

    <div class="round-slot" id="roundSlot2" title="Drag to reposition round image 2">
      <img id="roundImage2" class="round-img" alt="Round uploaded photo 2" style="display:none" />
      <img id="roundFrame2" class="frame-overlay" alt="Frame overlay 2" src="20251106_004524.png" style="display:none" />
    </div>

    <!-- date below rounds -->
    <div id="dateBadge" class="date-badge" contenteditable="true" aria-label="Event date">08 June 2026</div>

    <div class="headline" id="headlineBox">
      <h1 contenteditable="true" id="title">HAPPY</h1>
      <p contenteditable="true" id="sub">Birthday Christopher</p>
    </div>

    <div class="info" id="infoBox">
      <h2 contenteditable="true" id="tag">A blessed day!</h2>
      <ul id="bullets">
        <li contenteditable="true">The Lord bless you and keep you</li>
        <li contenteditable="true">The Lord make His face shine upon you</li>
        <li contenteditable="true">Numbers 6:24–26</li>
      </ul>
    </div>

    <div class="controls">
      <label for="fileInput" style="cursor:pointer;">Choose Photo</label>
      <input id="fileInput" type="file" accept="image/*" />
      <button id="removeBgBtn" disabled>Remove BG</button>
      <button class="zoom-btn" id="zoomOut">−</button>
      <button class="zoom-btn" id="zoomIn">+</button>

      <!-- main move buttons -->
      <div style="display:flex;gap:6px;align-items:center;">
        <button id="mainUp" class="small">M↑</button>
        <button id="mainDown" class="small">M↓</button>
        <button id="mainLeft" class="small">M←</button>
        <button id="mainRight" class="small">M→</button>
      </div>

      <div class="round-controls" style="margin-left:6px;">
        <button id="addRound1" class="small">Add R1</button>
        <button id="r1ZoomOut" class="small">r1−</button>
        <button id="r1ZoomIn" class="small">r1+</button>
        <button id="r1Up" class="small">↑</button>
        <button id="r1Down" class="small">↓</button>
        <button id="r1Left" class="small">←</button>
        <button id="r1Right" class="small">→</button>
        <input id="r1Color" type="color" title="R1 background color" value="#ffffff" class="small" style="padding:6px;">
      </div>

      <div class="round-controls">
        <button id="addRound2" class="small">Add R2</button>
        <button id="r2ZoomOut" class="small">r2−</button>
        <button id="r2ZoomIn" class="small">r2+</button>
        <button id="r2Up" class="small">↑</button>
        <button id="r2Down" class="small">↓</button>
        <button id="r2Left" class="small">←</button>
        <button id="r2Right" class="small">→</button>
        <input id="r2Color" type="color" title="R2 background color" value="#ffffff" class="small" style="padding:6px;">
      </div>

      <button id="editVerseBtn" class="small">Edit Verse</button>

      <!-- color controls for texts -->
      <div class="color-controls">
        <label style="font-size:12px">Title</label>
        <input id="titleColor" type="color" value="#ffffff">
        <label style="font-size:12px">Sub</label>
        <input id="subColor" type="color" value="#ffffff">
        <label style="font-size:12px">Tag</label>
        <input id="tagColor" type="color" value="#08314e">
        <label style="font-size:12px">Bullets</label>
        <input id="bulletsColor" type="color" value="#08314e">
        <label style="font-size:12px">Date</label>
        <input id="dateColor" type="color" value="#08314e">
      </div>

      <button id="downloadBtn">Export</button>
    </div>
  </div>

<!-- BodyPix (kept) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0.5/dist/body-pix.js"></script>

<script>
/* ---------- Elements ---------- */
const fileInput = document.getElementById('fileInput');
const userImage = document.getElementById('userImage');
const placeholder = document.getElementById('placeholder');
const slot = document.getElementById('slot');
const poster = document.getElementById('poster');
const titleEl = document.getElementById('title');

const roundSlot1 = document.getElementById('roundSlot1');
const roundImage1 = document.getElementById('roundImage1');
const roundFrame1 = document.getElementById('roundFrame1');
const addRound1 = document.getElementById('addRound1');
const r1ZoomIn = document.getElementById('r1ZoomIn');
const r1ZoomOut = document.getElementById('r1ZoomOut');
const r1Up = document.getElementById('r1Up');
const r1Down = document.getElementById('r1Down');
const r1Left = document.getElementById('r1Left');
const r1Right = document.getElementById('r1Right');
const r1Color = document.getElementById('r1Color');

const roundSlot2 = document.getElementById('roundSlot2');
const roundImage2 = document.getElementById('roundImage2');
const roundFrame2 = document.getElementById('roundFrame2');
const addRound2 = document.getElementById('addRound2');
const r2ZoomIn = document.getElementById('r2ZoomIn');
const r2ZoomOut = document.getElementById('r2ZoomOut');
const r2Up = document.getElementById('r2Up');
const r2Down = document.getElementById('r2Down');
const r2Left = document.getElementById('r2Left');
const r2Right = document.getElementById('r2Right');
const r2Color = document.getElementById('r2Color');

const dateBadge = document.getElementById('dateBadge');
const editVerseBtn = document.getElementById('editVerseBtn');
const bgGrid = document.getElementById('bgGrid');
const bgToggle = document.getElementById('bgToggle');

const mainUp = document.getElementById('mainUp');
const mainDown = document.getElementById('mainDown');
const mainLeft = document.getElementById('mainLeft');
const mainRight = document.getElementById('mainRight');

const titleColor = document.getElementById('titleColor');
const subColor = document.getElementById('subColor');
const tagColor = document.getElementById('tagColor');
const bulletsColor = document.getElementById('bulletsColor');
const dateColor = document.getElementById('dateColor');

let scale = 1, translateX = 0, translateY = 0;
let dragging = false, startX = 0, startY = 0;

let r1Enabled = false, r1Scale = 1, r1Tx = 0, r1Ty = 0, r1Dragging = false, r1StartX = 0, r1StartY = 0;
let r2Enabled = false, r2Scale = 1, r2Tx = 0, r2Ty = 0, r2Dragging = false, r2StartX = 0, r2StartY = 0;

/* ---------- backgrounds ---------- */
const bgFiles = [];
for (let i=1;i<=10;i++){ bgFiles.push('bg'+i+'.jpg'); }
bgFiles.forEach((f, idx) => {
  const img = document.createElement('img');
  img.src = f; img.alt = 'bg'+(idx+1); img.className = 'bg-thumb';
  img.addEventListener('click', ()=> {
    document.getElementById('bgImage').src = f;
    document.querySelectorAll('.bg-thumb').forEach(t=>t.classList.remove('selected'));
    img.classList.add('selected');
  });
  img.addEventListener('error', ()=>{ img.style.opacity = 0.28; img.title = 'Place '+f+' next to HTML'; });
  bgGrid.appendChild(img);
});
bgToggle.addEventListener('click', ()=>{ document.getElementById('bgImage').src = 'IMG-20251105-WA0012.jpg'; document.querySelectorAll('.bg-thumb').forEach(t=>t.classList.remove('selected')); });

/* ---------- Upload main image ---------- */
fileInput.addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ev => {
    userImage.src = ev.target.result;
    userImage.style.display = 'block';
    placeholder.style.display = 'none';
    scale = 1; translateX = translateY = 0; updateTransform();
    if(r1Enabled && !roundImage1.src){ roundImage1.src = userImage.src; roundImage1.style.display='block'; roundFrame1.style.display='block'; }
    if(r2Enabled && !roundImage2.src){ roundImage2.src = userImage.src; roundImage2.style.display='block'; roundFrame2.style.display='block'; }
  };
  r.readAsDataURL(f);
});

/* ---------- main image drag/zoom & nudge ---------- */
slot.addEventListener('pointerdown', e=> {
  if (userImage.style.display === 'none') return;
  dragging = true; startX = e.clientX; startY = e.clientY;
  slot.setPointerCapture && slot.setPointerCapture(e.pointerId);
});
window.addEventListener('pointermove', e=> {
  if(!dragging) return;
  translateX += e.clientX - startX; translateY += e.clientY - startY;
  startX = e.clientX; startY = e.clientY; updateTransform();
});
window.addEventListener('pointerup', ()=> dragging = false);
function updateTransform(){ userImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; }
document.getElementById('zoomIn').addEventListener('click', ()=>{ scale = Math.min(3.5, scale + 0.1); updateTransform(); });
document.getElementById('zoomOut').addEventListener('click', ()=>{ scale = Math.max(0.5, scale - 0.1); updateTransform(); });

// main nudge buttons (small increments)
mainUp && mainUp.addEventListener('click', ()=>{ translateY -= 8; updateTransform(); });
mainDown && mainDown.addEventListener('click', ()=>{ translateY += 8; updateTransform(); });
mainLeft && mainLeft.addEventListener('click', ()=>{ translateX -= 8; updateTransform(); });
mainRight && mainRight.addEventListener('click', ()=>{ translateX += 8; updateTransform(); });

/* ---------- arrange round slots to the LEFT (increased spacing) ---------- */
function arrangeRoundSlots() {
  const slotRect = slot.getBoundingClientRect();
  const posterRect = poster.getBoundingClientRect();
  const rW = roundSlot1.offsetWidth || 140;
  const rH = roundSlot1.offsetHeight || 140;

  // compute left edge for circles: left of main slot with gap
  const gap = 16; // increased gap
  const leftOfSlot = slotRect.left - posterRect.left - rW - gap;
  const safeLeft = Math.max(8, leftOfSlot);

  // R1: slightly above center-left
  const r1Top = slotRect.top - posterRect.top + 12;
  roundSlot1.style.left = safeLeft + 'px';
  roundSlot1.style.top = r1Top + 'px';
  roundSlot1.style.zIndex = 56;

  // R2: placed lower and a bit right with more spacing so they don't overlap too much
  const r2Top = r1Top + Math.round(rH * 0.62); // increased vertical offset (was 0.42)
  const r2Left = safeLeft + Math.round(rW * 0.28); // increased horizontal offset (was 0.16)
  roundSlot2.style.left = r2Left + 'px';
  roundSlot2.style.top = r2Top + 'px';
  roundSlot2.style.zIndex = 54;

  // position dateBadge under roundSlot2 (centered under both)
  const leftCenter = Math.round((parseInt(roundSlot1.style.left || 0) + parseInt(roundSlot2.style.left || 0)) / 2);
  const below = r2Top + rH + 6;
  dateBadge.style.left = (leftCenter) + 'px';
  dateBadge.style.top = (below) + 'px';
  dateBadge.style.display = (r1Enabled || r2Enabled) ? 'block' : 'none';
  dateBadge.style.zIndex = 53;

  // clamp inside poster
  const ensureInside = (el) => {
    const r = el.getBoundingClientRect();
    const left = r.left - posterRect.left;
    const top = r.top - posterRect.top;
    if (left < 6) el.style.left = '6px';
    if (top < 6) el.style.top = '6px';
    if (left + r.width > posterRect.width - 6) el.style.left = (posterRect.width - r.width - 6) + 'px';
    if (top + r.height > posterRect.height - 6) el.style.top = (posterRect.height - r.height - 6) + 'px';
  };
  ensureInside(roundSlot1);
  ensureInside(roundSlot2);
  ensureInside(dateBadge);
}

/* ---------- Round1 ---------- */
addRound1.addEventListener('click', ()=>{
  r1Enabled = !r1Enabled;
  if(r1Enabled){
    roundSlot1.classList.add('active'); addRound1.innerText='Remove R1';
    roundFrame1.style.display='block';
    roundSlot1.style.display='flex';
    if(!roundImage1.src && userImage.src){ roundImage1.src = userImage.src; roundImage1.style.display='block'; r1Scale=1; r1Tx=r1Ty=0; updateRound1(); }
    roundSlot1.style.background = r1Color.value;
  } else {
    roundSlot1.classList.remove('active'); addRound1.innerText='Add R1';
    roundImage1.style.display='none'; roundFrame1.style.display='none'; roundSlot1.style.display='none';
  }
  arrangeRoundSlots();
});
r1ZoomIn.addEventListener('click', ()=>{ r1Scale = Math.min(5, r1Scale + 0.08); updateRound1(); });
r1ZoomOut.addEventListener('click', ()=>{ r1Scale = Math.max(0.3, r1Scale - 0.08); updateRound1(); });
r1Up.addEventListener('click', ()=>{ r1Ty -= 6; updateRound1(); });
r1Down.addEventListener('click', ()=>{ r1Ty += 6; updateRound1(); });
r1Left.addEventListener('click', ()=>{ r1Tx -= 6; updateRound1(); });
r1Right.addEventListener('click', ()=>{ r1Tx += 6; updateRound1(); });
r1Color.addEventListener('input', ()=>{ roundSlot1.style.background = r1Color.value; });

roundSlot1.addEventListener('pointerdown', e=>{
  if (roundImage1.style.display === 'none') return;
  r1Dragging = true; r1StartX = e.clientX; r1StartY = e.clientY;
  roundSlot1.setPointerCapture && roundSlot1.setPointerCapture(e.pointerId);
  roundSlot1.style.cursor = 'grabbing';
});
window.addEventListener('pointermove', e=>{
  if(r1Dragging){ r1Tx += e.clientX - r1StartX; r1Ty += e.clientY - r1StartY; r1StartX = e.clientX; r1StartY = e.clientY; updateRound1(); }
});
window.addEventListener('pointerup', ()=>{ r1Dragging=false; roundSlot1.style.cursor='grab'; });
function updateRound1(){ roundImage1.style.transform = `translate(${r1Tx}px, ${r1Ty}px) scale(${r1Scale})`; roundSlot1.style.background = r1Color.value; }

/* ---------- Round2 ---------- */
addRound2.addEventListener('click', ()=>{
  r2Enabled = !r2Enabled;
  if(r2Enabled){
    roundSlot2.classList.add('active'); addRound2.innerText='Remove R2';
    roundFrame2.style.display='block';
    roundSlot2.style.display='flex';
    if(!roundImage2.src && userImage.src){ roundImage2.src = userImage.src; roundImage2.style.display='block'; r2Scale=1; r2Tx=r2Ty=0; updateRound2(); }
    roundSlot2.style.background = r2Color.value;
  } else {
    roundSlot2.classList.remove('active'); addRound2.innerText='Add R2';
    roundImage2.style.display='none'; roundFrame2.style.display='none'; roundSlot2.style.display='none';
  }
  arrangeRoundSlots();
});
r2ZoomIn.addEventListener('click', ()=>{ r2Scale = Math.min(5, r2Scale + 0.08); updateRound2(); });
r2ZoomOut.addEventListener('click', ()=>{ r2Scale = Math.max(0.3, r2Scale - 0.08); updateRound2(); });
r2Up.addEventListener('click', ()=>{ r2Ty -= 6; updateRound2(); });
r2Down.addEventListener('click', ()=>{ r2Ty += 6; updateRound2(); });
r2Left.addEventListener('click', ()=>{ r2Tx -= 6; updateRound2(); });
r2Right.addEventListener('click', ()=>{ r2Tx += 6; updateRound2(); });
r2Color.addEventListener('input', ()=>{ roundSlot2.style.background = r2Color.value; });

roundSlot2.addEventListener('pointerdown', e=>{
  if (roundImage2.style.display === 'none') return;
  r2Dragging = true; r2StartX = e.clientX; r2StartY = e.clientY;
  roundSlot2.setPointerCapture && roundSlot2.setPointerCapture(e.pointerId);
  roundSlot2.style.cursor = 'grabbing';
});
window.addEventListener('pointermove', e=>{
  if(r2Dragging){ r2Tx += e.clientX - r2StartX; r2Ty += e.clientY - r2StartY; r2StartX = e.clientX; r2StartY = e.clientY; updateRound2(); }
});
window.addEventListener('pointerup', ()=>{ r2Dragging=false; roundSlot2.style.cursor='grab'; });
function updateRound2(){ roundImage2.style.transform = `translate(${r2Tx}px, ${r2Ty}px) scale(${r2Scale})`; roundSlot2.style.background = r2Color.value; }

/* drag & drop upload to round slots */
roundSlot1.addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if(!f) return;
  const r = new FileReader(); r.onload = ev=>{ roundImage1.src=ev.target.result; roundImage1.style.display='block'; roundFrame1.style.display='block'; r1Scale=1; r1Tx=r1Ty=0; updateRound1(); }; r.readAsDataURL(f);
});
roundSlot1.addEventListener('dragover', e=>e.preventDefault());
roundSlot2.addEventListener('drop', e=>{
  e.preventDefault();
  const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
  if(!f) return;
  const r = new FileReader(); r.onload = ev=>{ roundImage2.src=ev.target.result; roundImage2.style.display='block'; roundFrame2.style.display='block'; r2Scale=1; r2Tx=r2Ty=0; updateRound2(); }; r.readAsDataURL(f);
});
roundSlot2.addEventListener('dragover', e=>e.preventDefault());

/* ---------- Title auto-fit ---------- */
function fitTitleToOneLine(){ const container = document.querySelector('.headline'); const maxWidth = container.clientWidth - 28; let fontSize = 64; titleEl.style.fontSize = fontSize + 'px'; while (titleEl.scrollWidth > maxWidth && fontSize > 28) { fontSize -= 2; titleEl.style.fontSize = fontSize + 'px'; } }
titleEl.addEventListener('input', fitTitleToOneLine);
window.addEventListener('resize', ()=>{ fitTitleToOneLine(); arrangeRoundSlots(); });
document.addEventListener('DOMContentLoaded', ()=>{ fitTitleToOneLine(); arrangeRoundSlots(); });

/* ---------- Verse editor (sync with .info) ---------- */
const verseEditorHTML = `
<div class="verse-editor" id="verseEditor" aria-hidden="true">
  <h3>Edit verse / description</h3>
  <div contenteditable="true" id="verseEditorTag" style="font-weight:700;"></div>
  <div contenteditable="true" id="verseEditorBullets" style="margin-top:8px;"></div>
  <div style="display:flex; gap:6px; margin-top:8px; justify-content:flex-end">
    <button id="verseSave" style="background:#0a58ca;color:#fff;border:none;padding:6px 10px;border-radius:6px">Save</button>
    <button id="verseClose" style="background:#ccc;color:#000;border:none;padding:6px 10px;border-radius:6px">Close</button>
  </div>
</div>`;
document.body.insertAdjacentHTML('beforeend', verseEditorHTML);
const verseEditor = document.getElementById('verseEditor');
const verseEditorTag = document.getElementById('verseEditorTag');
const verseEditorBullets = document.getElementById('verseEditorBullets');
const verseSave = document.getElementById('verseSave');
const verseClose = document.getElementById('verseClose');

function openVerseEditor(){
  verseEditor.style.display = 'block';
  verseEditorTag.innerText = document.getElementById('tag').innerText;
  verseEditorBullets.innerHTML = '';
  const items = Array.from(document.querySelectorAll('#bullets li')).map(li=>li.innerText);
  items.forEach(t => {
    const p = document.createElement('div'); p.contentEditable = 'true'; p.style.padding='4px 6px'; p.style.marginBottom='6px'; p.innerText = t;
    verseEditorBullets.appendChild(p);
  });
  verseEditor.setAttribute('aria-hidden','false');
}
function closeVerseEditor(){ verseEditor.style.display = 'none'; verseEditor.setAttribute('aria-hidden','true'); }

editVerseBtn.addEventListener('click', openVerseEditor);
verseClose.addEventListener('click', closeVerseEditor);
verseSave.addEventListener('click', ()=>{
  document.getElementById('tag').innerText = verseEditorTag.innerText.trim() || 'A blessed day!';
  const bulletsList = document.getElementById('bullets');
  bulletsList.innerHTML = '';
  const children = Array.from(verseEditorBullets.children);
  children.forEach(ch => {
    const txt = ch.innerText.trim();
    if(txt) {
      const li = document.createElement('li'); li.contentEditable = 'true'; li.innerText = txt;
      bulletsList.appendChild(li);
    }
  });
  closeVerseEditor();
});

/* ---------- BodyPix (kept) ---------- */
let bodyPixNet = null, bgRemoving = false;
async function enableRemoveButtonWhenReady(){ const btn = document.getElementById('removeBgBtn'); if (btn){ btn.disabled = false; btn.innerText = 'Remove BG'; } else setTimeout(enableRemoveButtonWhenReady,300); }
async function setupBgRemoval(){ try{ bodyPixNet = await bodyPix.load({architecture:'MobileNetV1', outputStride:16, multiplier:0.75, quantBytes:2}); enableRemoveButtonWhenReady(); } catch(e){ console.error(e); alert('BG model failed to load'); } }
async function removeBackgroundFromUserImage(){ if (!bodyPixNet){ alert('Model still loading'); return; } if (bgRemoving) return; const ui = userImage; if (!ui || !ui.src){ alert('Upload a photo first'); return; } bgRemoving = true; const btn = document.getElementById('removeBgBtn'); if(btn){ btn.innerText='Removing…'; btn.disabled=true; } try { const img = new Image(); img.crossOrigin='anonymous'; img.src = ui.src; await new Promise((r,rej)=>{ img.onload=r; img.onerror=rej; }); const seg = await bodyPixNet.segmentPerson(img, {flipHorizontal:false, internalResolution:'medium', segmentationThreshold:0.7}); const w = img.naturalWidth, h = img.naturalHeight; const out = document.createElement('canvas'); out.width=w; out.height=h; const ctx = out.getContext('2d'); ctx.drawImage(img,0,0,w,h); const imageData = ctx.getImageData(0,0,w,h); const pix = imageData.data; const s = seg.data; for (let i=0, p=0; i<s.length; i++, p+=4) { if (s[i]===1) pix[p+3]=255; else pix[p+3]=0; } ctx.putImageData(imageData, 0, 0); ui.src = out.toDataURL('image/png'); ui.style.display='block'; placeholder.style.display='none'; } catch(err){ console.error(err); alert('BG removal failed'); } finally { bgRemoving=false; if(btn){ btn.disabled=false; btn.innerText='Remove BG'; } } }
document.addEventListener('DOMContentLoaded', ()=>{ const btn=document.getElementById('removeBgBtn'); if(btn) btn.addEventListener('click', removeBackgroundFromUserImage); setupBgRemoval(); });

/* ---------- color controls for texts ---------- */
titleColor.addEventListener('input', ()=>{ document.querySelector('#title').style.color = titleColor.value; });
subColor.addEventListener('input', ()=>{ document.querySelector('#sub').style.color = subColor.value; });
tagColor.addEventListener('input', ()=>{ document.querySelector('#tag').style.color = tagColor.value; });
bulletsColor.addEventListener('input', ()=>{ document.querySelectorAll('#bullets li').forEach(li => li.style.color = bulletsColor.value); });
dateColor.addEventListener('input', ()=>{ dateBadge.style.color = dateColor.value; });

/* update bullets color when edited */
document.getElementById('bullets').addEventListener('input', ()=>{ document.querySelectorAll('#bullets li').forEach(li => li.style.color = bulletsColor.value); });

/* ---------- layout on load/resize ---------- */
window.addEventListener('resize', arrangeRoundSlots);
document.addEventListener('DOMContentLoaded', ()=>{ arrangeRoundSlots(); /* apply initial colors from inputs */ titleColor.dispatchEvent(new Event('input')); subColor.dispatchEvent(new Event('input')); tagColor.dispatchEvent(new Event('input')); bulletsColor.dispatchEvent(new Event('input')); dateColor.dispatchEvent(new Event('input')); });

/* ---------- Export placeholder ---------- */
/* If you want full export/drawRoundExport integrated with the new frame (20251106_004524.png), say "yes export" and I'll paste the final export block. */

</script>
</body>
</html>
