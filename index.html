<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Poster Editor — Final (Info near bottom)</title>
<style>
  :root {
    --poster-width: 800px;
    --poster-height: 1200px;
    --slot-right: 70px;
    --slot-top: 160px;
    --slot-width: 360px;
    --slot-height: 720px;
  }
  body {
    display: flex;
    justify-content: center;
    padding: 20px;
    background: #f3f4f6;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  .poster-frame {
    width: var(--poster-width);
    height: var(--poster-height);
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
    background: #fff;
  }

  .poster-frame .bg {
    position: absolute;
    inset: 0;
    object-fit: cover;
    z-index: 1;
    pointer-events: none;
  }

  .headline {
    position: absolute;
    top: 40px;
    left: 40px;
    z-index: 30;
    color: #fff;
    text-shadow: 0 3px 10px rgba(0, 0, 0, 0.5);
  }
  .headline h1 {
    margin: 0;
    font-size: 64px;
  }
  .headline p {
    margin: 5px 0 0 0;
    font-size: 22px;
    color: rgba(255, 255, 255, 0.95);
  }

  .photo-slot {
    position: absolute;
    right: var(--slot-right);
    top: var(--slot-top);
    width: var(--slot-width);
    height: var(--slot-height);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
  }

  .photo-slot img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    transform-origin: center;
    transition: transform 0.15s ease;
  }
  .photo-slot::after {
    content: "";
    position: absolute;
    inset: auto 0 0 0;
    height: 30%;
    background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
    opacity: 0.85;
    pointer-events: none;
  }

  /* Info box now sits near bottom margin */
  .info {
    position: absolute;
    left: 40px;
    bottom: 60px;
    width: calc(100% - 100px);
    max-width: 700px;
    background: rgba(255, 255, 255, 0.92);
    color: #0b3a61;
    border-radius: 10px;
    padding: 18px 22px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    z-index: 40;
  }
  .info h2 {
    margin: 0 0 8px 0;
    font-size: 20px;
  }
  .info ul {
    margin: 5px 0 0 18px;
    padding: 0;
  }
  .info li {
    margin: 5px 0;
    line-height: 1.35;
  }

  /* Upload and controls */
  .controls {
    position: absolute;
    bottom: 15px;
    right: 20px;
    z-index: 50;
    display: flex;
    gap: 6px;
  }
  .controls input {
    display: none;
  }
  .controls label,
  .controls button {
    background: #0a58ca;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
  }
  .controls .zoom-btn {
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
  }

  @media (max-width: 900px) {
    :root {
      --poster-width: 360px;
      --poster-height: 640px;
      --slot-width: 150px;
      --slot-height: 320px;
      --slot-top: 90px;
      --slot-right: 20px;
    }
    .headline h1 {
      font-size: 36px;
    }
    .info {
      width: calc(100% - 60px);
      left: 30px;
      bottom: 25px;
    }
  }
</style>
</head>
<body>
  <div class="poster-frame" id="poster">
    <img src="IMG-20251105-WA0012.jpg" alt="Poster background" class="bg" id="bgImage">

    <div class="photo-slot" id="slot">
      <img id="userImage" alt="Uploaded photo" style="display:none" />
      <div id="placeholder" style="color:#555;font-weight:600;">Upload photo here</div>
    </div>

    <div class="headline">
      <h1 contenteditable="true" id="title">HAPPY</h1>
      <p contenteditable="true" id="sub">Birthday Christopher</p>
    </div>

    <div class="info">
      <h2 contenteditable="true" id="tag">A blessed day!</h2>
      <ul id="bullets">
        <li contenteditable="true">The Lord bless you and keep you</li>
        <li contenteditable="true">The Lord make His face shine upon you</li>
        <li contenteditable="true">Numbers 6:24–26</li>
      </ul>
    </div>

    <div class="controls">
      <label for="fileInput">Choose Photo</label>
      <input type="file" id="fileInput" accept="image/*" />
      <button class="zoom-btn" id="zoomOut">−</button>
      <button class="zoom-btn" id="zoomIn">+</button>
      <button id="downloadBtn">Export</button>
    </div>
  </div>

<script>
const fileInput = document.getElementById('fileInput');
const userImage = document.getElementById('userImage');
const placeholder = document.getElementById('placeholder');
let scale = 1, translateX = 0, translateY = 0, dragging = false, startX = 0, startY = 0;

// Upload and preview
fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    userImage.src = ev.target.result;
    userImage.style.display = 'block';
    placeholder.style.display = 'none';
    scale = 1; translateX = translateY = 0;
    updateTransform();
  };
  reader.readAsDataURL(file);
});

function updateTransform() {
  userImage.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
}

// Drag image
const slot = document.getElementById('slot');
slot.addEventListener('pointerdown', e => {
  if (userImage.style.display === 'none') return;
  dragging = true;
  startX = e.clientX; startY = e.clientY;
  slot.setPointerCapture(e.pointerId);
});
window.addEventListener('pointermove', e => {
  if (!dragging) return;
  translateX += e.clientX - startX;
  translateY += e.clientY - startY;
  startX = e.clientX; startY = e.clientY;
  updateTransform();
});
window.addEventListener('pointerup', () => dragging = false);

// Zoom
document.getElementById('zoomIn').addEventListener('click', () => { scale = Math.min(3, scale + 0.1); updateTransform(); });
document.getElementById('zoomOut').addEventListener('click', () => { scale = Math.max(0.5, scale - 0.1); updateTransform(); });

// Export
document.getElementById('downloadBtn').addEventListener('click', async () => {
  const poster = document.getElementById('poster');
  const w = poster.clientWidth, h = poster.clientHeight;
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');

  // Draw background
  const bg = await loadImage(document.getElementById('bgImage').src);
  ctx.drawImage(bg, 0, 0, w, h);

  // Draw user image
  if (userImage.src) {
    const img = await loadImage(userImage.src);
    const slotRect = slot.getBoundingClientRect();
    const posterRect = poster.getBoundingClientRect();
    const sx = slotRect.left - posterRect.left;
    const sy = slotRect.top - posterRect.top;
    const sw = slotRect.width;
    const sh = slotRect.height;
    const imgRatio = img.width / img.height;
    const slotRatio = sw / sh;
    let drawW, drawH, dx, dy;
    if (imgRatio > slotRatio) {
      drawH = sh;
      drawW = img.width * (sh / img.height);
      dx = sx - (drawW - sw) / 2;
      dy = sy;
    } else {
      drawW = sw;
      drawH = img.height * (sw / img.width);
      dx = sx;
      dy = sy - (drawH - sh) / 2;
    }
    ctx.drawImage(img, dx + translateX, dy + translateY, drawW * scale, drawH * scale);
  }

  // Draw headline
  ctx.fillStyle = "#fff";
  ctx.font = "bold 64px system-ui";
  ctx.fillText(document.getElementById('title').innerText, 40, 90);
  ctx.font = "20px system-ui";
  ctx.fillText(document.getElementById('sub').innerText, 40, 130);

  // Draw info text
  ctx.fillStyle = "#08314e";
  ctx.font = "bold 20px system-ui";
  let y = h - 110;
  const bullets = Array.from(document.querySelectorAll('#bullets li')).map(li => li.innerText.trim());
  ctx.fillText(document.getElementById('tag').innerText, 40, y - 25);
  ctx.font = "18px system-ui";
  bullets.forEach(b => {
    ctx.fillText("• " + b, 40, y);
    y += 25;
  });

  const link = document.createElement('a');
  link.download = "poster_export.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});

function loadImage(src) {
  return new Promise((res, rej) => {
    const i = new Image();
    i.crossOrigin = "anonymous";
    i.onload = () => res(i);
    i.onerror = rej;
    i.src = src;
  });
}
</script>
  <!-- Add these CDN scripts once (place before your scripts that call bodyPix) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.0.5/dist/body-pix.js"></script>

<script>
/* Usage:
 - call setupBgRemoval() once on page load to create the control and load the model.
 - after a user uploads an image and userImage.src is set, call removeBackgroundFromUserImage().
*/
let bodyPixNet = null;
let bgRemoving = false;

async function setupBgRemoval() {
  // Optionally show a small status UI or disable the button until loaded
  console.log('Loading BodyPix model (may take a few seconds) ...');
  try {
    bodyPixNet = await bodyPix.load({
      architecture: 'MobileNetV1', // smaller and faster; change to 'ResNet50' for accuracy if needed
      outputStride: 16,
      multiplier: 0.75,
      quantBytes: 2
    });
    console.log('BodyPix loaded');
    // enable remove button if you have one in DOM
    const removeBtn = document.getElementById('removeBgBtn');
    if (removeBtn) removeBtn.disabled = false;
  } catch (err) {
    console.error('Failed loading BodyPix:', err);
    alert('Background removal model failed to load. Try reloading the page.');
  }
}

// Call this after the userImage is set (i.e., after upload)
async function removeBackgroundFromUserImage() {
  if (!bodyPixNet) {
    alert('Model still loading — please wait a few seconds and try again.');
    return;
  }
  if (bgRemoving) return; // prevent double clicks
  const userImageEl = document.getElementById('userImage');
  if (!userImageEl || !userImageEl.src) { alert('Upload a photo first'); return; }

  bgRemoving = true;
  const removeBtn = document.getElementById('removeBgBtn');
  removeBtn && (removeBtn.innerText = 'Removing…', removeBtn.disabled = true);

  try {
    // Create an offscreen image element to ensure naturalWidth/naturalHeight are available
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.src = userImageEl.src;

    await new Promise((res, rej) => {
      img.onload = () => res();
      img.onerror = e => rej(e);
    });

    // Run segmentation. tune parameters for speed/quality:
    // - internalResolution can be 'low' (faster) or 'high' (slower, more accurate)
    const segmentation = await bodyPixNet.segmentPerson(img, {
      flipHorizontal: false,
      internalResolution: 'medium', // 'low' | 'medium' | 'high'
      segmentationThreshold: 0.7,    // higher -> stricter person mask
    });

    // Create canvas same size as image
    const w = img.naturalWidth;
    const h = img.naturalHeight;
    const outCanvas = document.createElement('canvas');
    outCanvas.width = w;
    outCanvas.height = h;
    const outCtx = outCanvas.getContext('2d');

    // Draw original image to canvas
    outCtx.drawImage(img, 0, 0, w, h);

    // Get image pixels and segmentation data
    const imageData = outCtx.getImageData(0, 0, w, h);
    const pix = imageData.data; // RGBA

    // segmentation.data is a Uint8Array of 0/1 per pixel
    const seg = segmentation.data;

    // Iterate pixels and set alpha=0 for background
    for (let i = 0, p = 0; i < seg.length; i++, p += 4) {
      const isPerson = seg[i] === 1; // 1 means person
      if (!isPerson) {
        // set alpha to 0 (transparent) for background pixel
        pix[p + 3] = 0;
      } else {
        // keep alpha as is (255)
        pix[p + 3] = 255;
      }
    }

    // Put the modified image back into canvas
    outCtx.putImageData(imageData, 0, 0);

    // (Optional) If you want to refine the mask (smooth edges), you can apply a slight blur or use bodyPix.toMask + drawMask with opacity,
    // or postprocess segmentation (erosion/dilation) before applying alpha. This example uses direct mask.

    // Convert to dataURL (PNG keeps transparency) and set into your user image
    const dataUrl = outCanvas.toDataURL('image/png');
    userImageEl.src = dataUrl;

    // If your CSS relies on size, ensure the image is displayed (block) and placeholder hidden
    userImageEl.style.display = 'block';
    const placeholder = document.getElementById('placeholder');
    if (placeholder) placeholder.style.display = 'none';

  } catch (err) {
    console.error('Background removal failed:', err);
    alert('Background removal failed. See console for details.');
  } finally {
    bgRemoving = false;
    if (removeBtn) { removeBtn.innerText = 'Remove BG'; removeBtn.disabled = false; }
  }
}

// Start loading model automatically
setupBgRemoval();
</script>
</body>
</html>
